---
title: "Comparing new vs old versions of a file"
output: html_notebook
---

## Workflow

```{r}
## create test fixtures

# get id cols
id_cols <- c("id1", "id2")

base <- tibble::tibble(
  id1  = 1:4,
  id2  = LETTERS[1:4],
  num  = c(1, 2, NA_real_, 4),
  char = c(letters[1], NA_character_, letters[3:4]),
  int  = as.integer(c(1, NA_integer_, 2, 3)),
  log  = c(NA, TRUE, FALSE, NA),
  date = as.Date(c("2023-01-01", NA_character_, "2023-01-03", "2023-01-04"))
)

df1 <- base %>%
  
  ## create ID duplicates
  dplyr::add_row(
    id1  = 5,
    id2  = "E",
    num  = 5,
    char = "e",
    int  = 5L,
    log  = FALSE,
    date = as.Date("2023-01-05")
  ) %>%
  dplyr::add_row(
    id1  = 5,
    id2  = "E", 
    num  = 5,
    char = "g", # this value is different
    int  = 5L,
    log  = FALSE,
    date = as.Date("2023-01-05")
  ) %>%
  
  ## create exact duplicate, and row that is not in df2
  dplyr::add_row(
    id1  = 5,
    id2  = "Z",
    num  = 5,
    char = "e",
    int  = 5L,
    log  = FALSE,
    date = as.Date("2023-01-05")
  ) %>%
  dplyr::add_row(
    id1  = 5,
    id2  = "Z",
    num  = 5,
    char = "e",
    int  = 5L,
    log  = FALSE,
    date = as.Date("2023-01-05")
  ) %>%
  
  # add a row with a NA id value
  dplyr::add_row(
    id1  = 5,
    id2  = NA_character_, 
    num  = 5,
    char = "g",
    int  = 5L,
    log  = FALSE,
    date = as.Date("2023-01-05")
  ) %>%
  
  # create row with exact match in df2
  dplyr::add_row(
    id1  = 6,
    id2  = "M",
    num  = 5,
    char = "e",
    int  = 5L,
    log  = FALSE,
    date = as.Date("2023-01-05")
  ) %>%
  
  # # add a column not in df2
  # dplyr::mutate(extra1 = rep(1, 6)) %>%
  
  # add columns with same names and values as df2 but with different classes
  dplyr::mutate(class_num_char = rep(100, 10)) %>%
  dplyr::mutate(class_num_log = rep(NA_real_, 10)) %>%

  # make a column to look at differences in decimal places and tolerance
  dplyr::mutate(
    dec_diff_ref = rep(1, 10),
    dec_diff = rep(1, 10),
  )

df2 <- base %>%
  
  # add a row not in df1
  dplyr::add_row(
    id1  = 6,
    id2  = "F",
    num  = 6,
    char = "f",
    int  = 6L,
    log  = TRUE,
    date = as.Date("2023-01-06")
  ) %>%
  
  # create row with exact match in df1
  dplyr::add_row(
    id1  = 6,
    id2  = "M",
    num  = 5,
    char = "e",
    int  = 5L,
    log  = FALSE,
    date = as.Date("2023-01-05")
  ) %>%
  
  # duplicate the first row 3x
  dplyr::bind_rows(base[1, ]) %>%
  dplyr::bind_rows(base[1, ]) %>%
  dplyr::arrange(id1, id2) %>%
  
  # # add a column not in df1
  # dplyr::mutate(extra2 = rep(2, 7))  %>%
  
  # add columns with same names and values as df1 but with different classes
  dplyr::mutate(class_num_char = rep("100", 8)) %>%
  dplyr::mutate(class_num_log = rep(NA, 8)) %>%
  
  # make a column to look a differences in decimal places and tolerance
  dplyr::mutate(
    dec_diff_ref = c(0, 0, 0, -0.0001, -0.00001, -0.000001, 0, 1),
    dec_diff = 1 - dec_diff_ref
  ) %>%
  dplyr::mutate(dec_diff = dplyr::if_else(
    id1 == 6 & id2 == "M",
    1,
    dec_diff
  ))
  
df1
df2
```


```{r}
# check if there are different columns
(cc_out <- compare_cols(df1, df2))
```


```{r}
# if there were different columns, add dummy columns as needed
(df_list <- insert_dummy_cols(df1, df2, cc_out, id_cols))
```


```{r}
# order columns
(standard_cols <- standardize_col_order(df_list$df1, df_list$df2, id_cols))
```


```{r}
# find duplicates
(dup_list1 <- find_dups(standard_cols$df1, id_cols, source = "df1"))
(dup_list2 <- find_dups(standard_cols$df2, id_cols, source = "df2"))
```


```{r}
# compare data frames on de-duplicated data only
comp <- compare_df_wrapper(dup_list1$no_dups, 
                           dup_list2$no_dups, 
                           id_cols,
                           tolerance = 0.00001)
comp$comparison_df
comp$comparison_table_diff
```


```{r}
# get the results
comp_list <- segregate_compare(comparison_df = comp$comparison_df,
                               comparison_table_diff = comp$comparison_table_diff,
                               id_cols = id_cols,
                               cc_out = cc_out,
                               df1_exact_dups = dup_list1$exact_dups,
                               df2_exact_dups = dup_list2$exact_dups,
                               df1_id_dups = dup_list1$id_dups,
                               df2_id_dups = dup_list2$id_dups,
                               df1_id_NA = dup_list1$id_NA,
                               df2_id_NA = dup_list2$id_NA,
                               standard_col_list = standard_cols,
                               df1 = df1,
                               df2 = df2)

comp_list
```



```{r}
get_comparison(df1, df2, id_cols)
```



```{r}
#' Create Excel report for comparing two data frames
#' 
#' Creates a multi-tab report for comparing two data frames with one 
#' tab for each element of an object returned by [get_comparison()]
#' 
#' @param path a string, path of the Excel file to be written
#' @param comparison a list returned from [get_comparison()]
#' 
#' @returns nothing
#' @export
#' 
create_comparison_excel <- function (path, comparison) {
  
  
  
}
```







